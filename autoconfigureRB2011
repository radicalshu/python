#!/usr/bin/env python
#design by S.W
#For auto configure RB2011
#version beta0.2
#ChangeLOG :For sevral wans
#

import sys
import os
import time
import pexpect

rb_ip = '192.168.88.1'
user = 'admin'
#passwd = 'exun1234qwe'
loginprompt = '[>#$]'

def conf():
    telnet = pexpect.spawn("telnet %s" % rb_ip)
    telnet.expect('Login: ')
    telnet.sendline('admin')
    telnet.expect('Password:')
    telnet.sendline('')
    time.sleep(3)
    telnet.sendline('\r\n')
    telnet.expect(loginprompt)
    telnet.sendline('system identity set  name=%s' % city + '\r\n')
    telnet.sendline('ip dhcp-client remove numbers=ether1-gateway' + '\r\n')
    telnet.sendline('ip address add address=%s netmask=%s interface=ether1-gateway' % (internalip,netmask) +'\r\n')
    telnet.sendline('ip  pool add ranges=%s name=pool' % pool +'\r\n')
    telnet.sendline('ip dhcp-server remove numbers=0' + '\r\n')
    time.sleep(1)
    #telnet.sendline('interface set numbers=ether1-gateway name=ether1' + '\r\n')
    telnet.sendline('ip dhcp-server add name=server1 lease-time=02:00:00 interface=ether1-gateway address-pool=pool disable=no' + '\r\n')
    telnet.sendline('ip dhcp-server network add dns-server=%s address=%s/24 gateway=%s' % (internalip,network,internalip) + '\r\n')
    telnet.sendline('ip dhcp-server network remove numbers=1' + '\r\n')
    telnet.sendline('ip  dns set server=%s allow-remote-requests=yes '% internalip + '\r\n')
    telnet.sendline('ip firewall nat remove numbers=0,1' + '\r\n')
    for i in range(numbers):
        if linktype[i] == '1':
            telnet.sendline('interface pppoe-client add interface=ether%s-slave-local name=pppoe-out%s user=%s password=%s disabled=no use-peer-dns=yes add-default-route=yes' % (10-i,i+1,pppoe[i],mima[i])+ '\r\n')
            telnet.sendline('ip firewall nat add chain=srcnat action=masquerade out-interface=pppoe-out%s'% (i+1) + '\r\n' )
            telnet.sendline('ip route add dst-address=0.0.0.0/0 gateway=pppoe-out%s distance=5 check-gateway=ping'% (i+1)+ '\r\n')
        else :
            telnet.sendline('ip address add address=%s netmask=%s  disable=no interface=ether%s-slave-local' % (staticip[i],staticnetmask[i],10-i) + '\r\n')
            telnet.sendline('ip route add dst-address=0.0.0.0/0 gateway=%s distance=5 check-gateway=ping' %gateway[i] + '\r\n'  ) 
            telnet.sendline('ip firewall nat add chain=srcnat action=masquerade out-interface=ether%s-slave-local'% (10-i) +'\r\n')
    telnet.sendline('interface l2tp-client add  user=%s password=mt@009009 disable=no comment=vpn connect-to=119.253.36.34 name=l2tp-out1' % city +'\r\n')
    telnet.sendline('ip firewall nat add chain=srcnat action=masquerade out-interface=l2tp-out1'+ '\r\n')
    telnet.sendline('ip route add dst-address=192.168.0.0/16 gateway=172.16.0.1 distance=4 check-gateway=ping' + '\r\n')
    #telnet.sendline('ip firewall filter remove numbers=0,1,2,3,4' + '\r\n')
    telnet.sendline('ip firewall filter remove numbers=4' + '\r\n')
    telnet.sendline('ip firewall filter remove numbers=3' + '\r\n')
    telnet.sendline('ip firewall filter remove numbers=2' + '\r\n')
    telnet.sendline('ip firewall filter remove numbers=1' + '\r\n')
    telnet.sendline('ip firewall filter remove numbers=0' + '\r\n')
    telnet.sendline('snmp set enabled=yes trap-version=2' + '\r\n')
    telnet.sendline('snmp community set numbers=public addresses=172.16.0.1 read-access=yes' + '\r\n')
    #telnet.sendline('snmp community set name=public  read-access=yes addresses=172.16.0.1 numbers=0' + '\r\n')
    #telnet.sendline('ip firewall filter remove numbers=0,1,2,3,4' + '\r\n')



    #telnet.sendline('' + '\r\n')
    #print telnet.before
    #telnet.expect(loginprompt)
    #return telnet


def col():
    global city
    global internalip
    global netmask
    global network
    global pool
    global linktype #the way connect to the internet
    global staticip
    global staticnetmask
    global gateway
    global dns
    global pppoe
    global mima #password of the pppoe account
    #global i
    linktype = []
    staticip = []
    staticnetmask = []
    gateway = []
    dns = []
    pppoe = []
    mima = []
    city = raw_input('Please input the city: ')
    numbers = input('Please input the counts of the lines: ')
    internalip = raw_input('Please intput the internal network ip: ')
    netmask = raw_input('Netmask: ')
    network = raw_input('Network: ')
    pool = raw_input('Ip pool(like 172.16.16.10-172.16.16.240): ')
    for i in range(numbers):
        while True:
            #linktype[i] = input('1:PPPOE \n2:Static \nYour choice: ')
            a = raw_input('1:PPPOE \n2:Static \nYour choice: ')
            linktype.extend(a)
            if linktype[i] == '1':
                #pppoe[i] = input('Please input the pppoe account: ')
                pppoe_cache = raw_input('Please input the pppoe account: ')
                pppoe.extend(pppoe_cache)
                #mima[i] = input('Please input the pppoe password: ')
                mima_cache = raw_input('Please input the pppoe password: ')
                mima.extend(mima_cache)
                break
            elif linktype[i] == '2':
		staticip_cache = raw_input('Please input the staticip: ')
                staticip.extend(staticip_cache)
                #staticip[i] = input('Please input the staticip: ')
                #staticnetmask[i] = input('Please input the netmask: ')
                staticnetmask_cache = raw_input('Please input the netmask: ')
                staticnetmask.extend(staticnetmask_cache)
                #gateway[i] = input('Please input the gateway: ')
                gateway_cache = raw_input('Please input the gateway: ')
                gateway.extend(gateway_cache)
                #dns[i] = input('Please input the dns: ')
                dns_cache = raw_input('Please input the dns: ')
                dns.extend(dns_cache)
                break 
            else:
                print 'YOU input the wrong number' 
                continue
    conf()

def remove():#remove the default routerboard configuration
    delip = raw_input('remove which ip\'s deafult configuration: ')
    telnet = pexpect.spawn("telnet %s" % delip)
    telnet.expect('Login: ')
    telnet.sendline('admin')
    telnet.expect('Password:')
    telnet.sendline('')
    time.sleep(3)
    telnet.sendline('\r\n')
    telnet.expect(loginprompt)
    #telnet.sendline('interface bridge remove numbers=0' + '\r\n')
    telnet.sendline('interface bridge port remove numbers=4' + '\r\n')
    telnet.sendline('interface bridge port remove numbers=3' + '\r\n')
    telnet.sendline('interface bridge port remove numbers=2' + '\r\n')
    telnet.sendline('interface bridge port remove numbers=1' + '\r\n')
    telnet.sendline('interface bridge port remove numbers=0' + '\r\n')
    telnet.sendline('interface bridge remove numbers=0' + '\r\n')
    telnet.sendline('interface ethernet set numbers=1 name=ether1' +'\r\n')
    telnet.sendline('interface ethernet set numbers=6 name=ether6' +'\r\n')
    telnet.sendline('interface ethernet set numbers=7 name=ether7 master-port=none' +'\r\n')
    telnet.sendline('interface ethernet set numbers=8 name=ether8 master-port=none' +'\r\n')
    telnet.sendline('interface ethernet set numbers=9 name=ether9 master-port=none' +'\r\n')
    telnet.sendline('interface ethernet set numbers=10 name=ether10 master-port=none' +'\r\n')
    telnet.sendline('interface ethernet set numbers=2 master-port=ether1' +'\r\n')
    telnet.sendline('interface ethernet set numbers=3 master-port=ether1' +'\r\n')
    telnet.sendline('interface ethernet set numbers=4 master-port=ether1' +'\r\n')
    telnet.sendline('interface ethernet set numbers=5 master-port=ether1' +'\r\n')
    telnet.sendline('ip pool remove numbers=0' + '\r\n')




def main(argv):
    if len(sys.argv)== 2:
        if argv[1] == 'conf':
            col()
        elif argv[1] == 'remove':
            remove()
        elif sys.argv[1].startswith('--'):
            option = sys.argv[1][2:]
            if option == 'version':
                print 'autoconf2011-beta-0.2'
            elif option == 'help':
                print ''' --------------------------------------------
The program help you setup the RB2011UAS-RM easily.
Option include:
  conf       : Setup the RB2011UAS-RM
  remove     : Remove the default configuration of the RB2011UAS-RM
  --version  : Display the version of the program
  --help     : Display this help.'''
            else:
                print 'Please see --help'
        else:
            print 'Bad options'
    else :
        print 'No options'

if __name__ == '__main__':
    main(sys.argv)
